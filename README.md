# Power Manager for Dummy NUT Server

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

A standalone Bash script that simulates a NUT (Network UPS Tools) server's status based on network conditions. It's designed for homelabs and small offices where a UPS provides battery backup but lacks a USB/serial port for monitoring.

## About This Project

Many powerful, cost-effective UPS systems (like sine wave inverters with large external batteries) can power a server rack for hours but offer no way to signal a power failure to the connected devices. This script solves that problem by using a "canary in a coal mine" approach: it monitors several always-on devices (**sentinel hosts**) that are connected to standard, non-UPS grid power. If all of them go offline simultaneously, the script declares a power failure.

This script acts as the "brain" for a virtual NUT server, allowing standard NUT clients to perform a graceful shutdown.

### How It Works

The logic is simple but effective:

1.  **Monitor:** The script, running every minute via cron, pings a list of user-defined sentinel hosts (e.g., smart plugs, printers, IoT gadgets).
2.  **Decide:**
    * If **at least one** sentinel host is online, the script assumes grid power is OK. It tells the dummy NUT server that the status is `OL` (Online).
    * If **all** sentinel hosts are offline, the script assumes a power failure. It tells the dummy NUT server that the status is `OB LB` (On Battery, Low Battery).
3.  **Act:**
    * When NUT clients see the `OB LB` status, they initiate their own native shutdown procedures.
    * When power is restored, the script sets the status back to `OL` and, after a configurable delay, sends Wake-on-LAN (WoL) packets to wake the servers that were shut down.

This project is the perfect companion to the **[UPS_monitor](https://github.com/MarekWo/UPS_monitor)** client script, which is a lightweight client designed to react to the status changes generated by this Power Manager.


### Features

* **Hardware-Independent:** Works with any UPS, as it doesn't connect to it.
* **Reliable:** Uses multiple sentinel hosts to prevent false positives.
* **Standard-Compliant:** Controls a standard NUT server, making it compatible with any NUT client (Linux, Windows, Synology DSM, etc.).
* **Automated Recovery:** Includes a delayed Wake-on-LAN function to automatically restart servers after a stable power return.
* **Robust Logging:** Logs actions to both a local file and the system's syslog for easy monitoring.

### Prerequisites

1.  A dedicated, low-power machine that is **connected to the UPS** to run this script (e.g., a Raspberry Pi or an old laptop).
2.  A working **dummy NUT server** configured on that machine. A complete guide can be found in [this excellent Wiki guide](https://wiki.wojtaszek.it/pl/home/apps/nut/nut-server-install).
3.  A few reliable, always-on devices with static IPs on your network that are **NOT** connected to the UPS.

### Installation

1.  Clone the repository to a suitable location on your NUT server machine (e.g., `/opt/power-manager`).
    ```bash
    git clone https://github.com/MarekWo/PowerManager.git /opt/power-manager
    cd /opt/power-manager
    ```
2.  Make the main script executable.
    ```bash
    chmod +x power_manager.sh
    ```

### Configuration

1.  Copy the example configuration file.
    ```bash
    sudo cp /opt/power-manager/power_manager.conf.example /etc/nut/power_manager.conf
    ```
2.  Edit the configuration file with your specific network details.
    ```bash
    sudo nano /etc/nut/power_manager.conf
    ```

    * `SENTINEL_HOSTS`: A space-separated list of IPs for your sentinel devices.
    * `WAKE_HOSTS`: A space-separated list of servers to wake up, in `IP;MAC` format.
    * `WOL_DELAY_MINUTES`: Recommended to be 5-10 minutes.
    * `UPS_NAME` and `UPS_STATE_FILE`: These must match your NUT server configuration.
    * `BROADCAST_IP`: The broadcast address for the subnet where your servers reside.

### Usage

The script is designed to be run automatically every minute. Set it up using `cron`.

1.  Open the root crontab for editing:
    ```bash
    sudo crontab -e
    ```
2.  Add the following line to the end of the file:
    ```crontab
    * * * * * /opt/power-manager/power_manager.sh
    ```
3.  Save and exit. The script will now run every minute.

You can monitor its activity in real-time by tailing the log file:
```bash
tail -f /var/log/power_manager.log
```

### Updating

To update the script to the latest version, simply run the included update script from the repository directory:

```bash
cd /opt/power-manager
./update.sh
```

### License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.